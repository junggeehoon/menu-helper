# -*- coding: utf-8 -*-

# Form implementation generated from reading ui file 'untitled.ui'
#
# Created by: PyQt5 UI code generator 5.15.11
#
# WARNING: Any manual changes made to this file will be lost when pyuic5 is
# run again.  Do not edit this file unless you know what you are doing.

from PyQt5 import QtCore, QtGui, QtWidgets
from PyQt5.QtGui import QPixmap
from PyQt5.QtCore import Qt, QThread, pyqtSignal, QUrl # QUrl ì„í¬íŠ¸ ì¶”ê°€
from PyQt5.QtWidgets import QApplication, QTextBrowser # QTextBrowser ì„í¬íŠ¸ ì¶”ê°€

from api.openai_api import get_image_description
from api.google_image_search_api import search_image_urls
from utils.file_handler import get_image_file
import requests
import io
import json
import webbrowser # ì›¹ ë¸Œë¼ìš°ì € ì—´ê¸° ìœ„í•´ ì„í¬íŠ¸

# --- ìƒˆë¡œìš´ ìŠ¤ë ˆë“œ í´ë˜ìŠ¤: ìŒì‹ ì´ë¯¸ì§€ URL ê²€ìƒ‰ì„ ë‹´ë‹¹ ---
class FoodImageSearchThread(QThread):
    finished = pyqtSignal(int, str) # ì¸ë±ìŠ¤ì™€ URL ë°˜í™˜
    error = pyqtSignal(str)

    def __init__(self, query, index):
        super().__init__()
        self.query = query
        self.index = index # ì–´ë–¤ ìŒì‹ í•­ëª©ì¸ì§€ ì‹ë³„í•˜ê¸° ìœ„í•œ ì¸ë±ìŠ¤

    def run(self):
        try:
            # google_image_search_api.pyì—ì„œ Refererì™€ User-Agentë¥¼ ì´ë¯¸ ì„¤ì •í–ˆìœ¼ë¯€ë¡œ
            # ì—¬ê¸°ì„œëŠ” ë³„ë„ë¡œ í—¤ë”ë¥¼ ì¶”ê°€í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
            image_urls = search_image_urls(self.query, num_results=1)
            if image_urls:
                self.finished.emit(self.index, image_urls[0])
            else:
                self.finished.emit(self.index, None) # URLì„ ì°¾ì§€ ëª»í•˜ë©´ None ë°˜í™˜
        except Exception as e:
            self.error.emit(f"'{self.query}' ì´ë¯¸ì§€ ê²€ìƒ‰ ì‹¤íŒ¨: {e}")


class Ui_MainWindow(object):
    def setupUi(self, MainWindow):
        MainWindow.setObjectName("MainWindow")
        MainWindow.resize(1000, 700) # ì´ˆê¸° ì°½ í¬ê¸°ë¥¼ ì¡°ê¸ˆ ë” í‚¤ì› ìŠµë‹ˆë‹¤.

        self.centralwidget = QtWidgets.QWidget(MainWindow)
        self.centralwidget.setObjectName("centralwidget")

        self.main_horizontal_layout = QtWidgets.QHBoxLayout(self.centralwidget)
        self.main_horizontal_layout.setObjectName("main_horizontal_layout")

        # ì™¼ìª½ ì˜ì—­: ë©”ë‰´íŒ ì‚¬ì§„
        self.label_menu_image = QtWidgets.QLabel(self.centralwidget)
        self.label_menu_image.setAlignment(QtCore.Qt.AlignCenter)
        self.label_menu_image.setObjectName("label_menu_image")
        self.label_menu_image.setText("ë©”ë‰´íŒ ì´ë¯¸ì§€ë¥¼ ë¶ˆëŸ¬ì˜¤ì„¸ìš”")
        self.label_menu_image.setStyleSheet("border: 1px solid gray;") # í…Œë‘ë¦¬ ì¶”ê°€
        self.main_horizontal_layout.addWidget(self.label_menu_image, 2) # ìŠ¤íŠ¸ë ˆì¹˜ íŒ©í„° 2

        # ê°€ìš´ë° ì˜ì—­: GPT ì„¤ëª… ë° ë§í¬
        self.center_panel_widget = QtWidgets.QWidget(self.centralwidget)
        self.center_panel_widget.setObjectName("center_panel_widget")
        self.center_vertical_layout = QtWidgets.QVBoxLayout(self.center_panel_widget)
        self.center_vertical_layout.setContentsMargins(0, 0, 0, 0)
        self.center_vertical_layout.setObjectName("center_vertical_layout")

        # QTextEdit ëŒ€ì‹  QTextBrowser ì‚¬ìš©
        self.textEdit_gpt_description = QTextBrowser(self.center_panel_widget) # ë³€ê²½
        self.textEdit_gpt_description.setObjectName("textEdit_gpt_description")
        self.textEdit_gpt_description.setReadOnly(True)
        # QTextBrowserì˜ ê¸°ë³¸ ë™ì‘ì„ ì œì–´í•˜ì—¬ ë§í¬ í´ë¦­ ì‹œ ì™¸ë¶€ ë¸Œë¼ìš°ì €ë¥¼ ì—´ê³  ë‚´ë¶€ íƒìƒ‰ ë°©ì§€
        self.textEdit_gpt_description.setOpenExternalLinks(False) # ë§í¬ë¥¼ ë‚´ë¶€ì—ì„œ ì—´ì§€ ì•Šê³  ì‹œê·¸ë„ ë°œìƒ
        self.textEdit_gpt_description.setOpenLinks(False) # ë§í¬ í´ë¦­ ì‹œ QTexBrowserê°€ ìì²´ì ìœ¼ë¡œ í˜ì´ì§€ë¥¼ ë³€ê²½í•˜ì§€ ì•Šë„ë¡ ê°•ì œ
        self.textEdit_gpt_description.anchorClicked.connect(self.open_image_link) # anchorClicked ì‹œê·¸ë„ ì—°ê²°
        self.center_vertical_layout.addWidget(self.textEdit_gpt_description, 1)

        self.main_horizontal_layout.addWidget(self.center_panel_widget, 2)

        # ì˜¤ë¥¸ìª½ ì˜ì—­: ë²„íŠ¼ ë° ê¸°íƒ€ ì»¨íŠ¸ë¡¤
        self.right_panel_widget = QtWidgets.QWidget(self.centralwidget)
        self.right_panel_widget.setObjectName("right_panel_widget")
        self.right_vertical_layout = QtWidgets.QVBoxLayout(self.right_panel_widget)
        self.right_vertical_layout.setContentsMargins(0, 0, 0, 0)
        self.right_vertical_layout.setObjectName("right_vertical_layout")

        self.pushButton_load_menu = QtWidgets.QPushButton(self.right_panel_widget)
        self.pushButton_load_menu.setObjectName("pushButton_load_menu")
        self.pushButton_load_menu.setText("ë©”ë‰´íŒ ì´ë¯¸ì§€ ì—…ë¡œë“œ") # retranslateUiì—ì„œ ì—¬ê¸°ë¡œ ì˜®ê¹€
        self.pushButton_load_menu.clicked.connect(self.load_menu_image)
        self.right_vertical_layout.addWidget(self.pushButton_load_menu)

        spacerItem = QtWidgets.QSpacerItem(20, 40, QtWidgets.QSizePolicy.Minimum, QtWidgets.QSizePolicy.Expanding)
        self.right_vertical_layout.addItem(spacerItem)

        self.main_horizontal_layout.addWidget(self.right_panel_widget, 1)


        MainWindow.setCentralWidget(self.centralwidget)
        self.menubar = QtWidgets.QMenuBar(MainWindow)
        self.menubar.setGeometry(QtCore.QRect(0, 0, 1000, 37))
        self.menubar.setObjectName("menubar")
        MainWindow.setMenuBar(self.menubar)
        self.statusbar = QtWidgets.QStatusBar(MainWindow)
        self.statusbar.setObjectName("statusbar")
        MainWindow.setStatusBar(self.statusbar)

        self.retranslateUi(MainWindow)
        QtCore.QMetaObject.connectSlotsByName(MainWindow)

        self.image_path = None # ë©”ë‰´íŒ ì´ë¯¸ì§€ ê²½ë¡œ ì €ì¥ìš©
        self.gpt_result_food_data = [] # GPT ê²°ê³¼ì—ì„œ ì¶”ì¶œí•œ ìŒì‹ ë°ì´í„° (local_name, description, image_url) ì €ì¥

    def retranslateUi(self, MainWindow):
        _translate = QtCore.QCoreApplication.translate
        MainWindow.setWindowTitle(_translate("MainWindow", "ë©”ë‰´íŒ AI ë„ìš°ë¯¸"))
        # self.pushButton_load_menu.setText(_translate("MainWindow", "ë©”ë‰´íŒ ì´ë¯¸ì§€ ì—…ë¡œë“œ")) # setupUië¡œ ì´ë™

    def load_menu_image(self):
        path = get_image_file()
        if path:
            self.image_path = path
            pixmap = QPixmap(path).scaled(
                self.label_menu_image.size(), Qt.KeepAspectRatio, Qt.SmoothTransformation
            )
            self.label_menu_image.setPixmap(pixmap)
            # ë©”ë‰´íŒ ì´ë¯¸ì§€ ë¡œë“œ í›„ ë°”ë¡œ GPT ì„¤ëª… ìƒì„± ë° í˜„ì§€ì–´ ì¶”ì¶œ
            self.generate_description_and_extract_foods()
        else:
            print("ë©”ë‰´íŒ ì´ë¯¸ì§€ ì„ íƒ ì·¨ì†Œ")
            self.label_menu_image.setText("ë©”ë‰´íŒ ì´ë¯¸ì§€ë¥¼ ë¶ˆëŸ¬ì˜¤ì„¸ìš”")
            self.textEdit_gpt_description.clear()
            self.gpt_result_food_data = [] # ë°ì´í„° ì´ˆê¸°í™”

    def generate_description_and_extract_foods(self):
        # GPTì—ê²Œ í˜„ì§€ ì–¸ì–´ ë©”ë‰´ ì´ë¦„ê³¼ í•œêµ­ì–´ ì„¤ëª…ì„ ëª¨ë‘ ìš”ì²­
        prompt = """
        ì´ ì´ë¯¸ì§€ì— ìˆëŠ” ë©”ë‰´íŒì˜ ë©”ë‰´ë¥¼ ë¶„ì„í•˜ì—¬ ë‹¤ìŒ JSON í˜•ì‹ìœ¼ë¡œ ì œê³µí•´ì¤˜:
        {
            "menu_items": [
                {
                    "local_name": "[ë©”ë‰´1 ì›ë³¸ ì–¸ì–´ ì´ë¦„]",
                    "description": "[ë©”ë‰´1 ìŒì‹ì— ëŒ€í•œ ê°„ë‹¨í•œ í•œêµ­ì–´ ì„¤ëª…]"
                },
                {
                    "local_name": "[ë©”ë‰´2 ì›ë³¸ ì–¸ì–´ ì´ë¦„]",
                    "description": "[ë©”ë‰´2 ìŒì‹ì— ëŒ€í•œ ê°„ë‹¨í•œ í•œêµ­ì–´ ì„¤ëª…]"
                }
            ]
        }
        ë‹¤ë¥¸ ì¶”ê°€ í…ìŠ¤íŠ¸ ì—†ì´ ì˜¤ì§ JSONë§Œ ë°˜í™˜í•´ì¤˜.
        """

        if not self.image_path:
            self.textEdit_gpt_description.setPlainText("ë©”ë‰´íŒ ì´ë¯¸ì§€ë¥¼ ë¨¼ì € ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.")
            return

        self.textEdit_gpt_description.setPlainText("ë©”ë‰´íŒ ë¶„ì„ ì¤‘... ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”.")
        QApplication.processEvents() # UI ì—…ë°ì´íŠ¸ ê°•ì œ

        try:
            result_json_str = get_image_description(self.image_path, prompt)
            print("GPT ì›ë³¸ ì‘ë‹µ:", result_json_str) # ë””ë²„ê¹…ìš© ì¶œë ¥

            # --- ì‘ë‹µ ì „ì²˜ë¦¬ ---
            clean_json_str = result_json_str.strip()
            if clean_json_str.startswith("```json"):
                clean_json_str = clean_json_str[len("```json"):].strip()
            if clean_json_str.endswith("```"):
                clean_json_str = clean_json_str[:-len("```")].strip()

            start_idx = clean_json_str.find('{')
            end_idx = clean_json_str.rfind('}')

            if start_idx == -1 or end_idx == -1 or end_idx < start_idx:
                raise ValueError("GPT ì‘ë‹µì—ì„œ ìœ íš¨í•œ JSON ê°ì²´ì˜ ì‹œì‘ê³¼ ëì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")

            clean_json_str = clean_json_str[start_idx : end_idx + 1]
            # --- ì‘ë‹µ ì „ì²˜ë¦¬ ë ---

            gpt_data = json.loads(clean_json_str) # ì „ì²˜ë¦¬ëœ ë¬¸ìì—´ íŒŒì‹±

            # GPT ì‘ë‹µì—ì„œ ë°›ì€ ë°ì´í„°ë¥¼ self.gpt_result_food_dataì— ì €ì¥
            self.gpt_result_food_data = []
            for item in gpt_data.get("menu_items", []):
                local_name = item.get("local_name", "").strip()
                korean_desc = item.get("description", "").strip()
                if local_name: # local_nameì´ ìˆëŠ” ê²½ìš°ì—ë§Œ ì¶”ê°€
                    self.gpt_result_food_data.append({
                        "local_name": local_name,
                        "korean_description": korean_desc,
                        "image_url": None # ì´ˆê¸°ì—ëŠ” URL ì—†ìŒ
                    })
            print("GPT ë¶„ì„ ì™„ë£Œ. ìŒì‹ í•­ëª©:", [item['local_name'] for item in self.gpt_result_food_data])

            # GPT ë¶„ì„ í›„ ë°”ë¡œ ì´ë¯¸ì§€ ê²€ìƒ‰ ë° ì„¤ëª… ì—…ë°ì´íŠ¸ ì‹œì‘
            self.search_images_for_all_foods_and_update_display()


        except json.JSONDecodeError as e:
            print(f"GPT ì‘ë‹µ JSON íŒŒì‹± ì˜¤ë¥˜: {e}\níŒŒì‹± ì‹œë„ ë¬¸ìì—´:\n{clean_json_str}")
            self.textEdit_gpt_description.setPlainText(f"GPT ì‘ë‹µ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤: {e}\n\nì›ë³¸ ì‘ë‹µ:\n{result_json_str}")
        except ValueError as e: # ì „ì²˜ë¦¬ ì˜¤ë¥˜ ì²˜ë¦¬
            print(f"GPT ì‘ë‹µ ì „ì²˜ë¦¬ ì˜¤ë¥˜: {e}")
            self.textEdit_gpt_description.setPlainText(f"GPT ì‘ë‹µì„ ì²˜ë¦¬í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {e}\n\nì›ë³¸ ì‘ë‹µ:\n{result_json_str}")
        except Exception as e:
            print(f"GPT ì„¤ëª… ìƒì„± ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")
            self.textEdit_gpt_description.setPlainText("ë©”ë‰´íŒ ì„¤ëª…ì„ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.")

    # ëª¨ë“  ìŒì‹ì— ëŒ€í•´ ì´ë¯¸ì§€ ê²€ìƒ‰ ë° ì„¤ëª… ì—…ë°ì´íŠ¸
    def search_images_for_all_foods_and_update_display(self):
        if not self.gpt_result_food_data:
            self.textEdit_gpt_description.setPlainText("ë¶„ì„ëœ ìŒì‹ ë©”ë‰´ê°€ ì—†ìŠµë‹ˆë‹¤.")
            return

        # QThreadë¥¼ ì‚¬ìš©í•˜ì—¬ ê° ë©”ë‰´ ì•„ì´í…œì— ëŒ€í•œ ì´ë¯¸ì§€ ê²€ìƒ‰ì„ ë¹„ë™ê¸°ì ìœ¼ë¡œ ì‹œì‘
        self.image_search_threads = []
        for i, item in enumerate(self.gpt_result_food_data):
            local_name = item['local_name']
            if local_name:
                thread = FoodImageSearchThread(local_name, i)
                thread.finished.connect(self.update_food_item_with_image_url)
                self.image_search_threads.append(thread)
                thread.start()

        # ì´ˆê¸° ì„¤ëª… í…ìŠ¤íŠ¸ë¥¼ ë¨¼ì € í‘œì‹œ (ë§í¬ëŠ” ë‚˜ì¤‘ì— ìŠ¤ë ˆë“œ ê²°ê³¼ì— ë”°ë¼ ì—…ë°ì´íŠ¸ë¨)
        self.update_description_text_with_links()

    # ì´ë¯¸ì§€ URLì´ ê²€ìƒ‰ë˜ë©´ ë°ì´í„° ì—…ë°ì´íŠ¸ ë° UI ê°±ì‹ 
    def update_food_item_with_image_url(self, item_index, image_url):
        if 0 <= item_index < len(self.gpt_result_food_data):
            self.gpt_result_food_data[item_index]['image_url'] = image_url
            self.update_description_text_with_links() # URLì´ ì—…ë°ì´íŠ¸ë  ë•Œë§ˆë‹¤ UI ê°±ì‹ 

    # ì„¤ëª… í…ìŠ¤íŠ¸ë¥¼ HTML ë§í¬ì™€ í•¨ê»˜ ì—…ë°ì´íŠ¸
    def update_description_text_with_links(self):
        html_content = []
        for item in self.gpt_result_food_data:
            local_name = item.get("local_name", "")
            korean_desc = item.get("korean_description", "")
            image_url = item.get("image_url")

            line_content = f"- <b>{local_name}</b>" # ìŒì‹ ì´ë¦„ ë³¼ë“œ ì²˜ë¦¬

            if korean_desc:
                line_content += f": {korean_desc}"

            if image_url:
                # í•˜ì´í¼ë§í¬ ì¶”ê°€. ë§í¬ í…ìŠ¤íŠ¸ëŠ” "ì‚¬ì§„ë³´ê¸°" ë˜ëŠ” ğŸ“· ì´ëª¨ì§€ ì‚¬ìš©
                line_content += f' <a href="{image_url}" target="_blank">(ì‚¬ì§„ë³´ê¸°)</a>' # target="_blank" ì¶”ê°€
            else:
                line_content += " (ì´ë¯¸ì§€ ê²€ìƒ‰ ì¤‘...)" # ì´ë¯¸ì§€ ê²€ìƒ‰ ì¤‘ì„ì„ í‘œì‹œ

            html_content.append(line_content)

        self.textEdit_gpt_description.setHtml("<br>".join(html_content))

    # ë§í¬ í´ë¦­ ì‹œ ì™¸ë¶€ ë¸Œë¼ìš°ì €ë¡œ ì—´ê¸°
    def open_image_link(self, qurl_link): # ì¸ìë¥¼ QUrl ê°ì²´ë¡œ ë°›ìŒ
        link_str = qurl_link.toString()
        print(f"ë§í¬ í´ë¦­: {link_str}")
        webbrowser.open(link_str) # ê¸°ë³¸ ì›¹ ë¸Œë¼ìš°ì €ë¡œ ë§í¬ ì—´ê¸°